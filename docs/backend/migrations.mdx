---
title: 'Database Migrations'
description: 'Documentation for database structure and migrations in the InStore Reviews system'
---

# Database Migrations

This section documents the database structure and migration history of the InStore Reviews system.

## Core Tables

### Users and Authentication

```sql
-- Users Table
create_users_table (2014_10_12_000000)
  id bigint unsigned
  name varchar(255)
  email varchar(255) unique
  password varchar(255)
  timezone varchar(255)
  remember_token varchar(100)
  timestamps

-- Password Reset
create_password_reset_tokens_table (2014_10_12_100000)
  email varchar(255) primary
  token varchar(255)
  created_at timestamp

-- Verification Codes
create_verification_codes_table (2024_01_18_023506)
  id bigint unsigned
  code varchar(255)
  expires_at timestamp
  timestamps
```

### Business Management

```sql
-- Businesses
create_businesses_table (2024_01_12_015354)
  id bigint unsigned
  name varchar(255)
  settings json
  status varchar(255)
  timestamps

-- Business Locations
create_business_locations_table (2024_01_12_015355)
  id bigint unsigned
  business_id bigint unsigned foreign
  name varchar(255)
  address text
  settings json
  status varchar(255)
  timestamps

-- User Business Locations
create_user_business_locations_table (2024_01_12_015356)
  id bigint unsigned
  user_id bigint unsigned foreign
  business_location_id bigint unsigned foreign
  timestamps
```

### QR Code System

```sql
-- QR Media
create_qr_medias_table (2024_03_17_115610)
  id bigint unsigned
  filename varchar(255) unique
  template varchar(255)
  settings json
  timestamps

-- QR Media Locations
create_qr_media_locations_table (2024_03_17_115612)
  id bigint unsigned
  qr_media_id bigint unsigned foreign
  business_location_id bigint unsigned foreign
  settings json
  deleted_at timestamp
  timestamps

-- QR Scans
create_qr_scans_table (2024_04_02_064701)
  id bigint unsigned
  qr_media_id bigint unsigned foreign
  rating integer
  comment text
  metadata json
  timestamps
```

### Notification System

```sql
-- Notification Queues
create_notification_queues_table (2025_01_28_132654)
  id bigint unsigned
  type varchar(255)
  status varchar(255)
  payload json
  timestamps

-- Notification Alerts
create_notification_alerts_table (2024_06_07_014415)
  id bigint unsigned
  business_id bigint unsigned foreign
  type varchar(255)
  settings json
  timestamps

-- Notification Methods
create_notification_methods_table (2025_01_28_124910)
  id bigint unsigned
  name varchar(255)
  settings json
  timestamps
```

### Platform Integration

```sql
-- Platforms
create_platforms_table (2024_04_02_064700)
  id bigint unsigned
  name varchar(255)
  settings json
  timestamps

-- Business Location Platforms
create_business_location_platforms_table (2024_04_02_064702)
  id bigint unsigned
  business_location_id bigint unsigned foreign
  platform_id bigint unsigned foreign
  settings json
  timestamps
```

## Recent Changes

### 2025 Updates

1. **QR System Enhancements**
   - Added soft deletes to QR media locations
   - Added response timestamps to reviews
   - Enhanced QR scan analytics

2. **Notification System**
   - Implemented notification queues
   - Added notification logs
   - Enhanced SMS number management

### 2024 Updates

1. **Business Management**
   - Added cascade deletes for locations
   - Enhanced user-business relationships
   - Added platform integration support

2. **QR System**
   - Restructured QR media relationships
   - Added QR groups functionality
   - Enhanced QR scan tracking

## Migration Best Practices

### 1. Running Migrations

```bash
# Fresh installation
php artisan migrate

# Rollback last batch
php artisan migrate:rollback

# Reset and re-run all migrations
php artisan migrate:refresh

# Reset with seed data
php artisan migrate:refresh --seed
```

### 2. Creating New Migrations

```bash
# Create a new migration
php artisan make:migration create_table_name_table

# Create a modification migration
php artisan make:migration add_column_to_table_name_table
```

### 3. Foreign Keys

```php
// Adding foreign keys
$table->foreign('business_id')
      ->references('id')
      ->on('businesses')
      ->onDelete('cascade');

// Removing foreign keys
$table->dropForeign(['business_id']);
```

### 4. JSON Columns

```php
// Adding JSON columns
$table->json('settings')->nullable();

// Accessing JSON data
$model->settings->specific_key;
```

## Database Indexes

### Primary Indexes
- All `id` columns are primary keys
- Using `bigint unsigned` for scalability

### Foreign Key Indexes
- All foreign key columns are indexed
- Example: `business_id`, `user_id`

### Performance Indexes
```sql
-- Common queries optimization
CREATE INDEX idx_qr_scans_created_at ON qr_scans(created_at);
CREATE INDEX idx_qr_scans_rating ON qr_scans(rating);
```

## Related Documentation

- [Models](backend/models)
- [Relationships](backend/relationships)
- [Database Configuration](backend/database-config) 
